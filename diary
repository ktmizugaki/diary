#!/usr/bin/env perl
use lib 'lib';
use Plack::Builder;
use Mojolicious::Lite;
use Diary;

app->secrets(['diary']);

helper index_years => sub {
    my $c = shift;
    Diary::years;
};

helper entries_for_year => sub {
    my $c = shift;
    Diary::entries(@_);
};

get '/' => sub {
    my $c = shift;
    $c->stash(year => undef);
    $c->render('index');
} => 'index';

any [qw/GET POST/] => '/post' => sub {
    my $c = shift;
    $c->stash(year => undef);
    my ($date, $time) = Diary::now;
    $c->param(date => $date) unless $c->param('date');
    $c->param(time => $time) unless $c->param('time');
    $c->param(text => "") unless $c->param('text');

    $c->render('post');
} => 'post';

get '/:year' => [year => qr/\d{4}/] => sub {
    my $c = shift;
    $c->render('diary');
} => 'diary';

builder {
    enable "+MyRedirect";
    app->start;
}
